<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Chatbot de Documentos</title>
            <style>
      body {
        font-family: system-ui, sans-serif;
        max-width: 900px;
        margin: 2rem auto;
        padding: 0 1rem;
      }
      textarea {
        width: 100%;
        height: 80px;
        font-size: 1rem;
      }
      button {
        padding: 0.5rem 1rem;
        margin-top: 0.5rem;
        cursor: pointer;
      }
      .resultado {
        margin-top: 1rem;
        padding: 0.75rem;
        border-radius: 6px;
        border: 1px solid #ddd;
        background: #f9f9f9;
      }
      .fuente {
        font-size: 0.85rem;
        color: #555;
      }
      .score {
        font-size: 0.8rem;
        color: #999;
      }
    </style>
</head>
<body onload="loadPdfList()">

    <h1>Chatbot de Documentos FCyT</h1>
    
    <div>
        <h2>Agregar PDFs al Índice</h2>
        <form id="uploadForm">
            <p>Selecciona uno o más PDFs para **agregar** al índice existente.</p>
            <input type="file" id="pdfFiles" name="files" accept=".pdf" multiple required>
            <button type="submit">Agregar y Regenerar Índice</button>
        </form>
        <div id="uploadMessage" class="message" style="display:none;"></div>
    </div>
    <div>
        <h2>Documentos Cargados</h2>
        <div id="pdfListContainer">
            <p>Cargando documentos...</p>
        </div>
        <div id="deleteMessage" class="message" style="display:none;"></div>
    </div>
    <div>
        <h2>Hacer una Pregunta</h2>
        <form id="askForm">
            <input type="text" id="question" placeholder="Escribe tu pregunta aquí..." required>
            <button type="submit">Buscar Respuesta</button>
        </form>
        <div id="results"></div>
    </div>

    <script>
        // --- FUNCIONES DE GESTIÓN DE PDFS ---
        const pdfListContainer = document.getElementById('pdfListContainer');
        const deleteMessage = document.getElementById('deleteMessage');

        // Función para cargar la lista de PDFs
        async function loadPdfList() {
            try {
                const response = await fetch('/list-pdfs');
                const data = await response.json();
                
                pdfListContainer.innerHTML = ''; // Limpiar lista
                
                if (data.files && data.files.length > 0) {
                    data.files.forEach(filename => {
                        const listItem = document.createElement('div');
                        listItem.className = 'pdf-list-item';
                        listItem.innerHTML = `
                            <span>${filename}</span>
                            <button class="delete-btn" data-filename="${filename}">Eliminar</button>
                        `;
                        pdfListContainer.appendChild(listItem);
                    });

                    // Añadir evento a los botones de eliminar
                    document.querySelectorAll('.delete-btn').forEach(button => {
                        button.addEventListener('click', handleDelete);
                    });
                } else {
                    pdfListContainer.innerHTML = '<p>No hay documentos cargados actualmente.</p>';
                }
            } catch (error) {
                pdfListContainer.innerHTML = '<p class="error">Error al cargar la lista de documentos.</p>';
            }
        }

        // Función para manejar la eliminación
        async function handleDelete(e) {
            const filename = e.target.dataset.filename;
            if (!confirm(`¿Estás seguro de que quieres eliminar '${filename}' y regenerar el índice?`)) {
                return;
            }

            deleteMessage.style.display = 'block';
            deleteMessage.className = 'message';
            deleteMessage.innerHTML = `Eliminando ${filename} y regenerando índice...`;

            try {
                const response = await fetch('/delete-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename }),
                });

                const data = await response.json();
                
                if (response.ok) {
                    deleteMessage.className = 'message success';
                    deleteMessage.innerHTML = data.message;
                    loadPdfList(); // Recargar la lista de archivos
                } else {
                    deleteMessage.className = 'message error';
                    deleteMessage.innerHTML = 'Error al eliminar: ' + (data.detail || 'Fallo desconocido.');
                }
            } catch (error) {
                deleteMessage.className = 'message error';
                deleteMessage.innerHTML = 'Error de conexión durante la eliminación: ' + error.message;
            }
        }
        
        // --- Lógica para el Formulario de Subida (Modificada para recargar lista) ---
        const uploadForm = document.getElementById('uploadForm');
        const uploadMessage = document.getElementById('uploadMessage');

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('pdfFiles');
            const files = fileInput.files;

            if (files.length === 0) {
                alert("Por favor, selecciona al menos un archivo PDF.");
                return;
            }

            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }
            
            uploadMessage.style.display = 'block';
            uploadMessage.className = 'message';
            uploadMessage.innerHTML = 'Procesando archivos, agregando al índice y regenerando...';

            try {
                const response = await fetch('/upload-pdfs', {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();
                
                if (response.ok) {
                    uploadMessage.className = 'message success';
                    uploadMessage.innerHTML = data.message;
                    fileInput.value = ''; 
                    loadPdfList(); // <-- ¡NUEVO! Recargar la lista después de subir
                } else {
                    uploadMessage.className = 'message error';
                    uploadMessage.innerHTML = 'Error: ' + (data.detail || 'Fallo desconocido.');
                }
            } catch (error) {
                uploadMessage.className = 'message error';
                uploadMessage.innerHTML = 'Error de conexión: ' + error.message;
            }
        });

        // --- Lógica para el Formulario del Chatbot (sin cambios) ---
        const askForm = document.getElementById('askForm');
        const resultsDiv = document.getElementById('results');

        askForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const questionInput = document.getElementById('question');
            const question = questionInput.value.trim();

            if (!question) return;

            resultsDiv.innerHTML = '<p>Buscando respuesta...</p>';

            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: question }),
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultsDiv.innerHTML = '';
                    if (data.resultados && data.resultados.length > 0) {
                        data.resultados.forEach((r, index) => {
                            const resultElement = document.createElement('div');
                            resultElement.className = 'respuesta';
                            resultElement.innerHTML = `
                                <strong>${index + 1}. ${r.texto}</strong>
                                <div class="score">Fuente: ${r.fuente} (Similitud: ${r.score.toFixed(3)})</div>
                            `;
                            resultsDiv.appendChild(resultElement);
                        });
                    } else {
                        resultsDiv.innerHTML = '<p>No se encontraron resultados relevantes.</p>';
                    }
                } else {
                    resultsDiv.innerHTML = `<p style="color:red;">Error del servidor: ${response.statusText}</p>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p style="color:red;">Error de conexión: ${error.message}</p>`;
            }
        });
        
        // Cargar la lista de PDFs al cargar la página
        // La función `loadPdfList()` se llama con `onload` en la etiqueta <body>
    </script>

</body>
</html>